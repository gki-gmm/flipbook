<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced PDF Flipbook</title>
    
    <!-- Library Page Flip (Versi Stabil) -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js"></script>
    <!-- Library PDF.js (Versi Terbaru) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --dark: #1e293b;
            --light: #f8fafc;
            --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-hard: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #e2e8f0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* UI Controls Bar */
        .ui-bar {
            background: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-soft);
            z-index: 100;
            height: 60px;
        }

        .logo {
            font-weight: 800;
            color: var(--dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 600px;
            margin: 0 20px;
        }

        input.url-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input.url-input:focus { border-color: var(--primary); }

        button.btn-load {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        
        button.btn-load:hover { background: #1d4ed8; }

        /* Book Area */
        .book-stage {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            perspective: 1500px; /* Penting untuk efek 3D */
            background: radial-gradient(circle, #cbd5e1 1px, transparent 1px);
            background-size: 20px 20px; /* Pola titik background */
        }

        /* Container Flipbook */
        .flip-book {
            display: none;
            box-shadow: var(--shadow-hard);
            border-radius: 2px 4px 4px 2px; /* Sedikit lengkung di kiri buku */
        }

        /* Halaman */
        .page {
            background-color: white;
            overflow: hidden;
            border: 1px solid #ccc; /* Tepi kertas */
            backface-visibility: hidden; /* Optimasi performa */
        }

        .page-content {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* Loading & Status */
        .status-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            transition: opacity 0.3s;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .progress-bar-container {
            width: 300px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        /* Mobile Controls (Floating) */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            padding: 10px 20px;
            border-radius: 30px;
            display: none; /* Tampil hanya di mobile */
            gap: 20px;
            z-index: 200;
            box-shadow: var(--shadow-hard);
        }
        
        .mob-btn {
            color: white;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
        }

        .page-counter {
            color: white;
            font-size: 14px;
            font-family: monospace;
            align-self: center;
        }

        @media (max-width: 768px) {
            .ui-bar { height: auto; flex-direction: column; padding: 15px; gap: 10px; }
            .input-group { width: 100%; margin: 0; max-width: none; }
            .mobile-controls { display: flex; }
            .book-stage { padding: 20px 0; }
        }
    </style>
</head>
<body>

    <!-- UI Atas -->
    <div class="ui-bar">
        <div class="logo">üìö PDF FlipPro</div>
        <div class="input-group">
            <input type="text" id="pdf-url" class="url-input" placeholder="Tempel URL PDF GitHub / Raw di sini...">
            <button class="btn-load" onclick="handleLoad()">Render PDF</button>
        </div>
        <div style="font-size: 0.8rem; color: #64748b; display: none;" id="desktop-hint">Klik pinggir halaman untuk membalik</div>
    </div>

    <!-- Area Buku -->
    <div class="book-stage" id="stage">
        
        <!-- Status Loading -->
        <div class="status-overlay" id="loading-screen">
            <span class="loader"></span>
            <h3 id="status-text" style="margin-bottom: 5px;">Menyiapkan Engine...</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Flipbook Element -->
        <div class="flip-book" id="book"></div>

        <!-- Kontrol Mobile -->
        <div class="mobile-controls">
            <div class="mob-btn" onclick="flipPrev()">‚ùÆ</div>
            <div class="page-counter" id="page-num">0 / 0</div>
            <div class="mob-btn" onclick="flipNext()">‚ùØ</div>
        </div>
    </div>

<script>
    // --- KONFIGURASI UTAMA ---
    // Proxy ini sangat penting agar PDF dari GitHub bisa dibaca tanpa error CORS
    const PROXY_URL = 'https://corsproxy.io/?';
    
    // PDF Contoh Default (Mozilla PDF.js sample)
    const DEFAULT_URL = "https://raw.githubusercontent.com/gki-gmm/flipbook/refs/heads/main/WARTA JEMAAT GKI GMM EDISI 16 Tahun ke-22 (04-01-2026).pdf";
    
    // State Global
    let pageFlip = null;
    let pdfDoc = null;
    const bookEl = document.getElementById('book');
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const pageNumEl = document.getElementById('page-num');

    // Inisialisasi PDF.js Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Saat halaman dimuat
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userUrl = urlParams.get('url');
        const finalUrl = userUrl ? decodeURIComponent(userUrl) : DEFAULT_URL;
        
        document.getElementById('pdf-url').value = finalUrl;
        loadBook(finalUrl);
    };

    function handleLoad() {
        const url = document.getElementById('pdf-url').value.trim();
        if(!url) return alert("URL tidak boleh kosong");
        if (pageFlip) pageFlip.destroy();
        bookEl.innerHTML = ''; // Bersihkan DOM
        loadBook(url);
    }

    // --- CORE LOGIC: MEMUAT BUKU ---
    async function loadBook(url) {
        showLoading(true, "Mengunduh PDF...");
        progressBar.style.width = '0%';

        try {
            // 1. Gunakan Proxy untuk menghindari CORS
            const proxyUrl = PROXY_URL + encodeURIComponent(url);
            
            const loadingTask = pdfjsLib.getDocument({
                url: proxyUrl,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true
            });

            pdfDoc = await loadingTask.promise;
            
            const numPages = pdfDoc.numPages;
            updateStatus(`Membuat ${numPages} halaman...`);

            // 2. Render Halaman Satu per Satu (Async Loop) agar UI tidak macet
            const pages = [];
            let renderedCount = 0;

            for (let i = 1; i <= numPages; i++) {
                const pageDiv = createPageDiv(i);
                bookEl.appendChild(pageDiv);
                pages.push(pageDiv);

                // Render di background
                renderPdfPageToDiv(i, pageDiv).then(() => {
                    renderedCount++;
                    const percent = (renderedCount / numPages) * 100;
                    progressBar.style.width = percent + '%';
                });
                
                // Jeda kecil agar browser bisa bernafas (UI responsif)
                await new Promise(r => setTimeout(r, 10)); 
            }

            // 3. Inisialisasi PageFlip setelah DOM siap
            initPageFlip(pages);

        } catch (error) {
            console.error(error);
            showLoading(false);
            alert("Gagal memuat PDF. Pastikan URL valid.\nError: " + error.message);
        }
    }

    function createPageDiv(pageNum) {
        const div = document.createElement('div');
        div.className = 'page';
        
        const content = document.createElement('div');
        content.className = 'page-content';
        
        // Canvas untuk PDF
        const canvas = document.createElement('canvas');
        content.appendChild(canvas);
        div.appendChild(content);
        
        return div;
    }

    async function renderPdfPageToDiv(pageNum, div) {
        const page = await pdfDoc.getPage(pageNum);
        const canvas = div.querySelector('canvas');
        const context = canvas.getContext('2d');
        
        // Kualitas Render Tinggi (Scale 2.0 untuk Retina/High Res)
        const viewport = page.getViewport({ scale: 2.0 });
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        
        await page.render(renderContext).promise;
    }

    function initPageFlip(pages) {
        updateStatus("Memuat Efek 3D...");
        
        // Deteksi orientasi PDF dari halaman pertama
        pdfDoc.getPage(1).then(page => {
            const viewport = page.getViewport({ scale: 1 });
            const isLandscape = viewport.width > viewport.height;

            // Hitung ukuran optimal berdasarkan layar
            const containerW = window.innerWidth;
            const containerH = window.innerHeight - 80; // Kurangi header

            // Logika Ukuran Responsif Cerdas
            let bookW, bookH;

            if (window.innerWidth < 768) {
                // MOBILE: Single Page Mode
                bookW = containerW * 0.95; 
                bookH = containerW * 0.95 * (viewport.height / viewport.width);
                // Jika tingginya kepanjangan, batasi tinggi
                if(bookH > containerH * 0.9) {
                    bookH = containerH * 0.9;
                    bookW = bookH * (viewport.width / viewport.height);
                }
            } else {
                // DESKTOP: Double Page Mode
                // Kita ingin 2 halaman muat di layar dengan margin
                const targetWidth = (containerW * 0.8) / 2; // 80% lebar layar dibagi 2
                const targetHeight = containerH * 0.8;
                
                // Hitung berapa lebar satu halaman jika mengikuti tinggi target
                const calcWidth = targetHeight * (viewport.width / viewport.height);

                // Ambil yang lebih kecil agar muat (fit inside)
                const singlePageW = Math.min(targetWidth, calcWidth);
                
                bookW = singlePageW; 
                bookH = singlePageW * (viewport.height / viewport.width);
            }

            // Buat Instance PageFlip
            pageFlip = new St.PageFlip(bookEl, {
                width: bookW, // Lebar SATU halaman
                height: bookH, // Tinggi SATU halaman
                size: 'stretch',
                minWidth: 300,
                maxWidth: 1200,
                minHeight: 400,
                maxHeight: 1400,
                
                // Pengaturan Realisme
                maxShadowOpacity: 0.5,
                showCover: true,
                mobileScrollSupport: false, // Biar user bisa scroll HP keluar buku
                usePortrait: true, // Paksa portrait di mobile
                startPage: 0,
                drawShadow: true, // Render shadow manual di canvas
                flippingTime: 800, // Kecepatan balik
                useMouseEvents: true,
                swipeDistance: 30,
                clickEventForward: true,
                disableFlipByClick: false // Klik area halaman balik halaman
            });

            pageFlip.loadFromHTML(pages);

            // Event Listeners
            pageFlip.on('flip', (e) => {
                updatePageCounter(e.data + 1);
            });

            // Selesai loading
            showLoading(false);
        });
    }

    // --- HELPER FUNCTIONS ---

    function showLoading(show, text = "") {
        if (show) {
            loadingScreen.style.display = 'flex';
            statusText.innerText = text;
        } else {
            loadingScreen.style.opacity = '0';
            setTimeout(() => { loadingScreen.style.display = 'none'; }, 300);
            bookEl.style.display = 'block';
            document.getElementById('desktop-hint').style.display = 'block';
        }
    }

    function updateStatus(text) {
        statusText.innerText = text;
    }

    function updatePageCounter(current) {
        if(!pdfDoc) return;
        // Format: "1 - 2" untuk desktop, "1" untuk mobile
        // Kita tampilkan total halaman PDF saja untuk simplisitas
        pageNumEl.innerText = `${current} / ${pdfDoc.numPages}`;
    }

    // Kontrol Navigasi
    function flipNext() {
        if (pageFlip) pageFlip.flipNext();
    }

    function flipPrev() {
        if (pageFlip) pageFlip.flipPrev();
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') flipNext();
        if (e.key === 'ArrowLeft') flipPrev();
    });

</script>
</body>
</html>